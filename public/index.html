<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadaa Emart | Premium E-commerce</title>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Cairo:wght@400;600;700;800&family=Tajawal:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">

    <!-- i18n -->
    <script src="/js/i18n.js"></script>

    <style>
        /* Cart Badge Styles */
        .cart-container {
            position: relative;
            display: inline-block;
        }

        .cart-icon {
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
            padding: var(--space-xs) var(--space-sm);
        }

        .cart-icon:hover {
            transform: scale(1.1);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary-solid);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .rtl .cart-badge {
            right: auto;
            left: -5px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="/" class="logo" data-i18n="nav.home">Jadaa Emart</a>

            <nav id="nav-menu">
                <button id="lang-toggle" class="btn-outline btn-sm">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>

                <!-- Cart Icon -->
                <div class="cart-container">
                    <a href="profile.html#cart" class="cart-icon" title="Shopping Cart">
                        ðŸ›’
                        <span class="cart-badge" id="cart-count">0</span>
                    </a>
                </div>

                <a href="login.html" class="btn btn-outline btn-sm" data-i18n="nav.login">Login</a>
                <a href="register.html" class="btn btn-sm" data-i18n="nav.register">Register</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Hero Section -->
        <section class="hero">
            <h1 data-i18n="hero.title">Discover Premium Quality Products</h1>
            <p data-i18n="hero.subtitle">Explore our curated collection of electronics, fashion, and more</p>
        </section>

        <!-- Search & Filter Section -->
        <section class="search-filter">
            <div
                style="max-width: 800px; margin: 0 auto var(--space-lg); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                <input type="text" id="search-input" data-i18n-placeholder="search.placeholder"
                    placeholder="Search products..." style="flex: 1; min-width: 250px;" />
                <select id="category-filter" style="min-width: 180px;">
                    <option value="" data-i18n="search.all_categories">All Categories</option>
                </select>
                <select id="sort-select" style="min-width: 150px;">
                    <option value="newest">Newest First</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="name">Name: A-Z</option>
                </select>
            </div>
        </section>

        <!-- Products Grid -->
        <div id="products-grid" class="grid">
            <div class="loading">
                <div class="spinner"></div>
                <p data-i18n="messages.loading">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="background: var(--bg-secondary); margin-top: var(--space-xl); padding: var(--space-xl) var(--space-lg); border-top: 1px solid var(--border-light);">
        <div class="container" style="text-align: center;">
            <p data-i18n="footer.copyright">Â© 2025 Jadaa Emart. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const nav = document.getElementById('nav-menu');
        const productsGrid = document.getElementById('products-grid');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const sortSelect = document.getElementById('sort-select');

        let allProducts = [];
        let categories = [];

        // Update Navigation based on auth status
        function updateNavigation() {
            const langToggle = `<button id="lang-toggle" class="btn-outline btn-sm"></button>`;
            const cartIcon = `
                <div class="cart-container">
                    <a href="${token ? 'profile.html#cart' : 'login.html'}" class="cart-icon" data-i18n-title="cart.title" title="Shopping Cart">
                        ðŸ›’
                        <span class="cart-badge" id="cart-count">0</span>
                    </a>
                </div>
            `;

            if (token) {
                const isRTL = i18n.isRTL();
                const adminLink = user.role === 'admin' ?
                    `<a href="admin.html" class="btn btn-outline btn-sm" data-i18n="nav.admin">${i18n.t('nav.admin')}</a>` : '';

                nav.innerHTML = `
                    ${langToggle}
                    ${cartIcon}
                    ${adminLink}
                    <a href="profile.html" class="btn btn-outline btn-sm" data-i18n="nav.profile">${i18n.t('nav.profile')}</a>
                    <button onclick="logout()" class="btn btn-sm" data-i18n="nav.logout">${i18n.t('nav.logout')}</button>
                `;

                updateCartCount();
            } else {
                nav.innerHTML = `
                    ${langToggle}
                    ${cartIcon}
                    <a href="login.html" class="btn btn-outline btn-sm" data-i18n="nav.login">${i18n.t('nav.login')}</a>
                    <a href="register.html" class="btn btn-sm" data-i18n="nav.register">${i18n.t('nav.register')}</a>
                `;
            }

            i18n.setupLanguageToggle();
        }

        // Update Cart Count
        async function updateCartCount() {
            if (!token) return;

            try {
                const response = await fetch('/api/products/cart', {
                    headers: { 'x-access-token': token }
                });

                if (response.ok) {
                    const cart = await response.json();
                    const totalItems = cart.items ? cart.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
                    const badge = document.getElementById('cart-count');
                    if (badge) {
                        badge.textContent = totalItems;
                        badge.style.display = totalItems > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Fetch Categories
        async function fetchCategories() {
            if (!token) return;

            try {
                const response = await fetch('/api/products/categories', {
                    headers: { 'x-access-token': token }
                });

                if (response.ok) {
                    categories = await response.json();
                    populateCategoryFilter();
                }
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }

        function populateCategoryFilter() {
            const defaultOption = `<option value="" data-i18n="search.all_categories">${i18n.t('search.all_categories')}</option>`;
            const categoryOptions = categories.map(cat =>
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');

            categoryFilter.innerHTML = defaultOption + categoryOptions;
        }

        // Fetch Products
        async function fetchProducts() {
            if (!token) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-xl); background: var(--bg-card); border-radius: var(--border-radius-lg); border: 1px solid var(--border-light); backdrop-filter: blur(20px);">
                        <h2 style="margin-bottom: var(--space-md);" data-i18n="messages.login_required">${i18n.t('messages.login_required')}</h2>
                        <p style="color: var(--text-muted); margin-bottom: var(--space-lg);">${i18n.t('hero.subtitle')}</p>
                        <a href="login.html" class="btn btn-lg" data-i18n="nav.login">${i18n.t('nav.login')}</a>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch('/api/products', {
                    headers: { 'x-access-token': token }
                });

                if (!response.ok) throw new Error('Failed to fetch products');

                allProducts = await response.json();
                filterAndDisplayProducts();

            } catch (error) {
                productsGrid.innerHTML = `
                    <div class="alert alert-error" style="grid-column: 1 / -1;">
                        ${i18n.t('messages.error')}: ${error.message}
                    </div>
                `;
            }
        }

        function filterAndDisplayProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const sortBy = sortSelect.value;

            let filtered = allProducts.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                    (product.description || '').toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || product.category_id == selectedCategory;

                return matchesSearch && matchesCategory;
            });

            // Sort products
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'price-low':
                        return parseFloat(a.price) - parseFloat(b.price);
                    case 'price-high':
                        return parseFloat(b.price) - parseFloat(a.price);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'newest':
                    default:
                        return b.id - a.id;
                }
            });

            displayProducts(filtered);
        }

        function displayProducts(products) {
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-xl); color: var(--text-muted);">
                        <h3 data-i18n="search.no_results">${i18n.t('search.no_results')}</h3>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = products.map(product => {
                const categoryName = product.Category ? product.Category.name : i18n.t('product.category');
                const inStock = product.stock > 0;

                return `
                    <div class="card">
                        <div class="card-img">
                            ${product.image && !product.image.includes('placeholder') ?
                        `<img src="${product.image}" alt="${product.name}" onerror="this.parentElement.innerText='${product.name[0] || 'P'}'"/>` :
                        `${product.name[0] || 'P'}`
                    }
                        </div>
                        <div class="card-body">
                            <span class="category">${categoryName}</span>
                            <h3 class="card-title">${product.name}</h3>
                            <p class="card-desc">${product.description || ''}</p>
                            <div class="card-footer">
                                <span class="price">$${parseFloat(product.price).toFixed(2)}</span>
                                <button 
                                    class="btn btn-sm ${!inStock ? 'btn-disabled' : ''}" 
                                    onclick="addToCart(${product.id})"
                                    ${!inStock ? 'disabled' : ''}
                                    data-i18n="product.add_to_cart"
                                >
                                    ${inStock ? i18n.t('product.add_to_cart') : i18n.t('product.out_of_stock')}
                                </button>
                            </div>
                            <div style="margin-top: var(--space-sm); font-size: 0.85rem; color: ${inStock ? 'var(--accent-green)' : '#ef4444'};">
                                <span data-i18n="product.stock">${i18n.t('product.stock')}</span>: ${product.stock}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add to Cart
        async function addToCart(productId) {
            if (!token) {
                alert(i18n.t('messages.login_required'));
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/products/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': token
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    showMessage(i18n.t('messages.product_added'), 'success');
                    updateCartCount();
                } else {
                    const error = await response.json();
                    showMessage(error.message || i18n.t('messages.error'), 'error');
                }
            } catch (error) {
                showMessage(i18n.t('messages.error'), 'error');
            }
        }

        // Event Listeners
        searchInput.addEventListener('input', filterAndDisplayProducts);
        categoryFilter.addEventListener('change', filterAndDisplayProducts);
        sortSelect.addEventListener('change', filterAndDisplayProducts);

        // Show Message
        function showMessage(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '100px';
            alert.style.right = i18n.isRTL() ? 'auto' : '20px';
            alert.style.left = i18n.isRTL() ? '20px' : 'auto';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.init();
            updateNavigation();
            await fetchCategories();
            await fetchProducts();

            // Update cart count every 30 seconds
            if (token) {
                setInterval(updateCartCount, 30000);
            }
        });
    </script>
</body>

</html>